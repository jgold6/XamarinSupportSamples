<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
    <title>Xamarin University</title>
    <script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js"></script>
    <link rel="stylesheet" type="text/css" href="./res/styles/normalize.css">
    <link rel="stylesheet" type="text/css" href="./res/styles/styles.css">
    <script src="./res/js/script.js"></script>
</head>

<body>
   <header>Advanced Cross Platform Mobile Development</header>
   <section id="main">

   <h1>Exercise 3: Using Dependency Injection</h1>
   <h2>Duration</h2>
   <p>30 minutes</p>
        
   <h2>Goals</h2>
   <p>
   This final exercise will replace the Factory pattern used in the first exercise with a Dependency Injection container that will supply the quote loader as part of the constructor. You will then optionally, remove the Service Locator as well and just use the DI/IoC container injection approach.
   </p>

   <h2>Assets</h2>
   <p>
   This exercise includes a starter project in the <strong>Part 03 Resources</strong> folder. You can either use this project, or just continue from the prior exercise. In addition, there is an <b>Infrastructure</b> folder which has an example IoC Container implementation we will be using.
   </p>

   <h2>Challenge</h2>
   <p>
   This exercise takes our existing <b>Great Quotes</b> application and modify it to use Dependency Injection with an IoC container. We will be supplying the <code>IQuoteRepository</code> service to the existing <code>QuoteManager</code> so that it may then load the quotes. We will also modify the <code>QuoteLoader</code> code in each platform to use the container to create the quotes so we can inject the <code>ITextToSpeech</code> service.</p>

   <h1>Steps</h1>

   <p>Here are the basic steps you will go through:</p>
   <ol class="indent-large">
      <li>Add an existing IoC container into the project - this is contained in the <b>Infrastructure</b> folder in the lab resources. This is a simple container designed to show you the principles, you are free to use it however you like, however it is recommneded that for real applications you would choose a supported 3<sup>rd</sup> party container - several are listed in the worksheet.</li>
      <li>Modify the <code>QuoteManager</code> to take the <code>IQuoteRepository</code> dependency as a constructor parameter; since this is required, it makes sense to use constructor injection.</li> 
      <li>In your platform projects, add an instance of the container as a field to your application class.</li>
      <li>Modify each of the platform projects to register the <code>IQuoteRepository</code> with the container.</li>
      <li>Finally, create the <code>QuoteManager</code> using the container.</li>
   </ol>

   <h2>Adding the DI/IoC Container</h2>
   <ol>
      <li>In the <b>Infrastructure</b> folder under <b>Part 03 Resources</b> you will find a <code>SimpleContainer</code> class. This is a very simple implementation of an IoC container that allows you to register and create types. Go ahead and add it into your PCL.</li>

      <div class="hintblock"><strong>Note:</strong> We will use this as an example - but keep in mind that it is deliberately simplified so you can see the concepts involved and trace through the code if you like. For non-sample applications you should consider a real IoC container.</div>

      <li>Go ahead and examine the code - it has two methods (with two variations on each):</li>

      <table class="grid indent-large">
         <tr>
           <th>Method</th>
           <th>Description</th>
         </tr>
         <tr>
           <td><code>Register</code></td>
           <td>This is used to register known abstractions with the container. You register a creator <em>function</em> with the abstraction type so it may be created, or just pass the implementation type if it has a default constructor. It allows the container to resolve interfaces to types similar to a Service Locator. You could also actually use a Service Locator for this purpose if you wanted to.</td>
         </tr>
           <td><code>FactoryFor&lt;T&gt;</code></td>
           <td>This method is used to create a factory method which will create the <strong>T</strong> type. It returns a <code>Func&lt;T&gt;</code> where the implementation goes through the container to generate the type. This can be used to create factory methods so consumers do not have to have a reference to the container itself.</td>
         <tr>
         </tr>
         <tr>
           <td><code>Create</code></td>
           <td>This method is used to create types. If the type is a registered type, then the associated registration method is used. Otherwise, if the type has a public, default constructor, then it will be used to create the object. If the type does not, then the code will pick the first public constructor and attempt to create each of the required parameters by recursively calling <code>Create</code> and then finally construct the final object passing each of the parameters. If it is unable to create the given type, a <code>null</code> is returned.</td>
         </tr>
      </table>
    </ol>

   <h2>Modify the Quote Manager to take constructor parameters</h2>
   <p>Next, let's change the  to receive all their dependencies through injection.</p>
   <ol>
      <li>Open the <code>QuoteManager</code> and add a new parameter to the constructor of type <code>IQuoteRepository</code>. Assign the passed parameter to a field. Make sure to remove the existing code that uses the Factory approach.</li>
      
      <div class="hintblock">
        <strong>Note:</strong> You will probably need to modify your singleton approach so that the client <em>creates</em> the object and then you store off the created instance in your singleton - check and make sure only one gets created. See the example code below if you need a hint. Here we will remove our reliance on the <code>Lazy&lt;T&gt;</code> and instead just store off the value in the constructor. Also, <strong>Make sure your constructor is public!</strong>
      </div>

      <p class="indent-none"><a href="#" onclick="toggleCode(this,'quoteRepo');return false;" class="uiitem">Show Code</a><div class="indent-large" id="quoteRepo" style="display:none;">
<pre class="prettyprint">
public class QuoteManager
{
  public static QuoteManager Instance { get; private set; }

  readonly IQuoteRepository repo;

  public IList&lt;GreatQuote&gt; Quotes { get; private set; }

  <span class="highlight">public</span> QuoteManager(<span class="highlight">IQuoteRepository repo</span>)
  {
    if (Instance != null)
      throw new Exception("Can only create a single QuoteManager.");
    Instance = this;

    <strike>repo = QuoteRepositoryFactory.Create();</strike>
    <span class="highlight">this.repo = repo;</span>
    Quotes = repo.Load().ToList();
  }

  public void Save()
  {
    repo.Save(Quotes);
  }
}
</pre>
  </div></p>
  </ol>

  <h2>Setup the DI container</h2>
  <p>We need to register our abstractions in each of the platform specific projects so you will perform these steps for both the iOS and Android projects.</p>
  <h3>iOS</h3>
   <ol>
      <li>Open the <code>AppDelegate</code> in the iOS project.</li>
      <li>Add a new <code>SimpleContainer</code> field and new up an instance.</li>
      <li>Remove the Factory code from the <code>FinishedLaunching</code> method.</li>
      <li>In the <code>FinishedLaunching</code> method, register the <code>IQuoteRepository</code> abstraction with the proper implementations using the container's <code>Register&lt;T,TImpl&gt;</code> method.</li>
      <li>Create the <code>QuoteManager</code> with the container's <code>Create</code> method.</li>
      <li>Run the iOS application and make sure it all still works - try putting a breakpoint into the <code>QuoteManager</code> constructor to see the injected parameter.</li>
   </ol>
    <p><a href="#" onclick="toggleCode(this,'ios_VM');return false;" class="uiitem">Show Code</a><div class="indent-large" id="ios_VM" style="display:none;">
<pre class="prettyprint">
public partial class AppDelegate : UIApplicationDelegate
{
  <span class="highlight">readonly SimpleContainer container = new SimpleContainer();</span>

  public override UIWindow Window { get; set; }

  public override void FinishedLaunching(UIApplication application)
  {
    <strike>QuoteRepositoryFactory.Create = () => new QuoteLoader();</strike>

    <span class="highlight">container.Register&lt;IQuoteRepository, QuoteLoader&gt;();
    container.Create&lt;QuoteManager&gt;();</span>

    ServiceLocator.Instance.Add&lt;ITextToSpeech, TextToSpeechService&gt;();
  }

</pre>
  </div></p>
  <h3>Android</h3>
   <ol>
      <li>Open the <code>App.cs</code> in the Android project.</li>
      <li>Add a new <code>SimpleContainer</code> field and new up an instance.</li>
      <li>Remove the Factory code from the <code>OnCreate</code> method.</li>
      <li>In the <code>OnCreate</code> method, register the <code>IQuoteRepository</code> abstraction with the proper implementations using the container's <code>Register&lt;T,TImpl&gt;</code> method.</li>
      <li>Create the <code>QuoteManager</code> with the container's <code>Create</code> method.</li>
      <li>Run the Android application and make sure it all still works.</li>
   </ol>
    <p><a href="#" onclick="toggleCode(this,'android_VM');return false;" class="uiitem">Show Code</a><div class="indent-large" id="android_VM" style="display:none;">
<pre class="prettyprint">
public class App : Application
{
  <span class="highlight">readonly SimpleContainer container = new SimpleContainer();</span>

  public App(IntPtr h, JniHandleOwnership jho) : base(h, jho)
  {
  }

  public override void OnCreate()
  {
    <strike>QuoteRepositoryFactory.Create = () => new QuoteLoader();</strike>

    <span class="highlight">container.Register&lt;IQuoteRepository, QuoteLoader&gt;();
    container.Create&lt;QuoteManager&gt;();</span>

    ServiceLocator.Instance.Add&lt;ITextToSpeech, TextToSpeechService&gt;();

    base.OnCreate();
  }
}
</pre>
   </div></p>
   
    <h2>Extra Challenge: Refactor</h2>
    <p>
      The container is only being used to create the <code>QuoteManager</code>, and that class uses the passed <code>IQuoteLoader</code> to create the quotes. The quotes use the <code>ITextToSpeech</code> using the Service Locator to find the implementation. What if we wanted to remove this dependency?
    </p>
    <p>
      One option is, you could use the container to create the quotes - passing the <code>ITextToSpeech</code> interface into the constructor of each quote, in the same way we did here with the <code>QuoteManager</code>. However, this would still require some way to look up the container in the <code>QuoteLoader</code> implementation (since it creates the quotes). This is often done by combining the service locator and DI container approach - registering the container with the locator, looking up the container and then creating the child objects. However this puts you back into the position of having a hard dependency, now against the container instead of a locator. It works, but it's not ideal.
    </p>
    <p>
      Instead, think about using the <em>Factory</em> pattern we talked about earlier: could you pass in a factory method to create child objects instead? Specifically one that goes through the container - so we only need a dependency that returns a <code>GreatQuote</code> and not the container itself. You could use an interface, or even a <code>Func&lt;GreatQuote&gt;</code> to accomplish this.
    </p>
    <p>
      Try to work that out on your own, it's not as easy as it sounds! The final solution for this exercise has the code completed if you'd like to see one way to implement this. In addition, it consolidates the setup code and <code>QuoteLoader</code> into a Shared Project so we maximize the final sharing solution.
    </p>

   <h1>Summary</h1>
    <p>
    In this exercise, you have taken an existing iOS and/or Android application and utilized a DI/IoC container to loosely couple dependencies together.
    </p>
    <p>
    There is a completed version of the lab exercise in the resources folder.</p>

    <div class="align-right">
        <a href="../Start%20Here.html">Go Back</a>
    </div>

  </section>
  <footer>Copyright (C) 2014 Xamarin</footer>

</body>

</html>
